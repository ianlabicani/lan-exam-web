@let takenExam = takenExamSig();
@let examItemsSig = examItems();
@let examObj = takenExam?.exam;

@if (takenExam) {
	<!-- Check if exam is still ongoing (not closed) -->
	@if (examObj?.status === 'ongoing' || examObj?.status === 'published' || examObj?.status === 'closed') {
		<!-- Pending Grading View (Exam still ongoing or grading in progress) -->
		<div class="mx-auto max-w-4xl">
			<!-- Back Button -->
			<div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex items-center justify-between">
					<div class="flex items-center gap-4">
						<a routerLink="/student/taken-exams" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-white/20 hover:bg-white/30 transition-colors duration-200">
							<fa-icon [icon]="faArrowLeft" class="text-white"></fa-icon>
						</a>
						<h1 class="text-xl font-bold text-white">Exam Results</h1>
					</div>
      </div>

			<!-- Main Card -->
			<div class="bg-white rounded-xl shadow-md p-8 text-center">
				<!-- Success Icon -->
				<div class="mb-6">
					<div class="mx-auto w-24 h-24 bg-green-100 rounded-full flex items-center justify-center">
						<fa-icon [icon]="faCheckCircle" class="text-green-600 text-5xl"></fa-icon>
					</div>
				</div>

				<!-- Main Message -->
				<h2 class="text-2xl font-bold text-gray-900 mb-3">Exam Submitted Successfully!</h2>
				<p class="text-lg text-gray-600 mb-6">
					Your exam has been successfully submitted on {{ takenExam.submitted_at | date: 'MMM dd, y h:mm a' }}
				</p>

				<!-- Pending Message -->
				<div class="max-w-2xl mx-auto bg-yellow-50 border-2 border-yellow-200 rounded-lg p-6 mb-6">
					<div class="flex items-start">
						<fa-icon [icon]="faClock" class="text-yellow-600 text-3xl mr-4 mt-1" style="min-width: 2rem;"></fa-icon>
						<div class="text-left flex-1">
							<h3 class="text-lg font-bold text-yellow-900 mb-2">
								@if (takenExam.status === 'graded') {
									Graded - Awaiting Release
								} @else {
									Results Pending Grading
								}
							</h3>
							<p class="text-yellow-800 mb-3">
								@if (takenExam.status === 'graded') {
									Your exam has been graded by your teacher! Results and detailed feedback will be visible once the teacher closes the exam for all students.
								} @else {
									Your exam is currently being reviewed by your teacher. Results and detailed feedback will be available once grading is complete and the exam is closed.
								}
							</p>
							<div class="bg-yellow-100 rounded-lg p-3">
								<p class="text-sm font-semibold text-yellow-900 mb-1">What happens next:</p>
								<ul class="text-sm text-yellow-800 space-y-1">
									@if (takenExam.status === 'graded') {
										<li>
											<fa-icon [icon]="faCheckCircle" class="text-green-600 mr-2"></fa-icon>Your responses have been graded
										</li>
										<li>
											<fa-icon [icon]="faCheckCircle" class="text-green-600 mr-2"></fa-icon>Scores and feedback are ready
										</li>
										<li>
											<fa-icon [icon]="faArrowRight" class="text-yellow-600 mr-2"></fa-icon>Teacher will close the exam when all students are graded
										</li>
										<li>
											<fa-icon [icon]="faArrowRight" class="text-yellow-600 mr-2"></fa-icon>You'll be able to view your complete results after closure
										</li>
									} @else {
										<li>
											<fa-icon [icon]="faArrowRight" class="text-yellow-600 mr-2"></fa-icon>Your teacher will review your responses
										</li>
										<li>
											<fa-icon [icon]="faArrowRight" class="text-yellow-600 mr-2"></fa-icon>Manual grading items (essays, short answers) will receive scores and feedback
										</li>
										<li>
											<fa-icon [icon]="faArrowRight" class="text-yellow-600 mr-2"></fa-icon>Once grading is complete, teacher will close the exam
										</li>
										<li>
											<fa-icon [icon]="faArrowRight" class="text-yellow-600 mr-2"></fa-icon>You'll be able to view your results and feedback after closure
										</li>
									}
								</ul>
							</div>
						</div>
					</div>
				</div>

				<!-- Exam Status Badge -->
				<div class="inline-flex items-center px-6 py-3 bg-blue-50 rounded-lg border-2 border-blue-200 mb-6">
					<fa-icon [icon]="faCheckCircle" class="text-blue-600 text-xl mr-3"></fa-icon>
					<div class="text-left">
						<p class="text-sm text-blue-600 font-semibold">Current Exam Status:</p>
						<p class="text-lg font-bold text-blue-900">
							@if (examObj?.status === 'ongoing') {
								<span class="text-orange-600">Ongoing</span> - Accepting submissions
							} @else if (examObj?.status === 'closed') {
								<span class="text-purple-600">Closed</span> - Being graded
							} @else {
								{{ examObj?.status | titlecase }}
							}
						</p>
					</div>
				</div>

				<!-- Submission Details -->
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto mb-6">
					<div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
						<p class="text-sm text-gray-600 mb-1">Submitted On</p>
						<p class="text-lg font-bold text-gray-900">
							{{ takenExam.submitted_at | date: 'MMM dd, y' }}
						</p>
						<p class="text-sm text-gray-600">
							{{ takenExam.submitted_at | date: 'h:mm a' }}
						</p>
					</div>

					@if (takenExam.status === 'graded') {
						<div class="bg-green-50 p-4 rounded-lg border border-green-200">
							<p class="text-sm text-green-600 mb-1">Grading Status</p>
							<p class="text-lg font-bold text-green-900">
								<fa-icon [icon]="faCheckCircle" class="mr-1" ></fa-icon>Graded
							</p>
							<p class="text-sm text-green-700">
								Waiting for exam to close
							</p>
						</div>
					} @else {
						<div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
							<p class="text-sm text-orange-600 mb-1">Grading Status</p>
							<p class="text-lg font-bold text-orange-900">
								<fa-icon [icon]="faHourglassHalf" class="mr-1" ></fa-icon>Pending
							</p>
							<p class="text-sm text-orange-700">
								Awaiting teacher review
							</p>
						</div>
					}
				</div>

				<!-- Action Buttons -->
				<div class="flex flex-col sm:flex-row gap-3 justify-center">
					<a routerLink="/student/exams" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition duration-200 inline-flex items-center justify-center gap-2">
						<fa-icon [icon]="faFileAlt"></fa-icon>Browse More Exams
					</a>

					<a routerLink="/student/exams/taken-exams" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition duration-200 inline-flex items-center justify-center gap-2">
						<fa-icon [icon]="faHistory"></fa-icon>View Exam History
					</a>
				</div>

				<!-- Help Text -->
				<div class="mt-8 pt-6 border-t border-gray-200">
					<p class="text-sm text-gray-500">
						<fa-icon [icon]="faQuestionCircle" class="mr-1"></fa-icon>
						Check back later to view your results. You'll receive your score and detailed feedback once the exam is closed by your teacher.
					</p>
				</div>
			</div>
		</div>
	} @else {
		<!-- Graded View - Show Questions (Blade-like) -->
		<div class="mx-auto max-w-4xl p-6 space-y-6 bg-white/70 backdrop-blur rounded-xl shadow-sm border border-slate-200">
			<div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-md p-6 mb-6">
				<h2 class="text-2xl font-bold mb-2">{{ examObj?.title }}</h2>
				<p class="text-indigo-100">{{ examObj?.description }}</p>
			</div>

			<div class="space-y-6">
				@for (item of examItemsSig; track item.id; let idx = $index) {
					<div class="bg-white rounded-xl shadow-md p-6">
						<div class="flex items-start justify-between mb-4">
							<div class="flex-1">
								<div class="flex items-center mb-2">
									<span class="px-3 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full uppercase mr-3">
										{{ item.type.replace('_',' ') }}
									</span>
									<span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm font-semibold rounded-full">
										<fa-icon [icon]="faCheckCircle" class="text-yellow-500 mr-1" ></fa-icon>{{ item.points }} pts
									</span>
								</div>
								<h3 class="text-lg font-bold text-gray-900">{{ item.question }}</h3>
							</div>

							<div class="ml-4">
								@if (isItemCorrect(item) === true) {
									<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">Correct</span>
								} @else if (isItemCorrect(item) === null) {
									<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Manual</span>
								} @else {
									<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">Incorrect</span>
								}
							</div>
						</div>

						<div class="mb-4 p-4 rounded-lg border {{ isItemCorrect(item) === true ? 'bg-green-50 border-green-200' : (isItemCorrect(item) === null ? 'bg-gray-50 border-gray-200' : 'bg-red-50 border-red-200') }}">
							<p class="text-sm font-semibold text-gray-700 mb-2">Student's Answer:</p>
							<p class="text-gray-900">{{ getStudentAnswerText(item) }}</p>
						</div>

						@let correctText = getCorrectAnswerText(item);
						@if (correctText) {
							<div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
								<p class="text-sm font-semibold text-blue-700 mb-2">Correct Answer:</p>
								<p class="text-blue-900">{{ correctText }}</p>
							</div>
						}

						@let ansObj = getAnswerObj(item.id);
						@if (ansObj && (ansObj.points_earned !== null || ansObj.feedback)) {
							<div class="mt-4 pt-4 border-t border-gray-200">
								<div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
									@if (ansObj.feedback) {
										<div class="mb-2">
											<p class="text-sm font-semibold text-indigo-700 mb-1">Teacher Feedback:</p>
											<p class="text-indigo-900 whitespace-pre-wrap">{{ ansObj.feedback }}</p>
										</div>
									}
								</div>
							</div>
						}

						<div class="mt-4 pt-4 border-t border-gray-200">
							<div class="flex items-center justify-between">
								<span class="text-sm font-semibold text-gray-700">Points Earned:</span>
								<span class="text-lg font-bold {{ getAnswerPoints(item.id) === item.points ? 'text-green-600' : 'text-orange-600' }}">
									{{ getAnswerPoints(item.id) ?? 0 }} / {{ item.points }}
								</span>
							</div>
						</div>
					</div>
				}
			</div>

			<!-- Sidebar summary -->
			<div class="mt-6">
				<div class="p-4 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg text-white mb-6">
					<p class="text-sm opacity-90 mb-1">Total Score</p>
					<p class="text-4xl font-bold">{{ takenExam?.total_points ?? 0 }}<span class="text-xl opacity-75">/ {{ examObj?.total_points }}</span></p>
				</div>
				<div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
					<div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
						<span class="text-sm text-blue-700">Total Questions</span>
						<span class="font-bold text-blue-900">{{ totalQuestions() }}</span>
					</div>
					<div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg">
						<span class="text-sm text-purple-700">Answered</span>
						<span class="font-bold text-purple-900">{{ answeredCount() }}</span>
					</div>
					<div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
						<span class="text-sm text-green-700">Correct</span>
						<span class="font-bold text-green-900">{{ correctCount() }}</span>
					</div>
				</div>
			</div>
		</div>
	}
} @else {
	<div class="max-w-md mx-auto mt-16 flex flex-col items-center gap-4 text-slate-500">
		<svg class="size-10 animate-pulse text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
			<path d="M12 6v6l4 2" stroke-linecap="round" stroke-linejoin="round" />
		</svg>
		<p>Loading taken exam...</p>
	</div>
}
