@let takenExamSig = takenExam();
@let examItemsSig = examItems();
@let timerData = examTimerData();
@let activityEventsList = activityEvents();
@let summary = activitySummary();

<!-- Activity Monitor Component -->
<app-activity-monitor
  [events]="activityEventsList"
  [summary]="summary"
  [isOpen]="showEventPanel()"
  (togglePanel)="toggleEventPanel()"
/>

@if (takenExamSig) {
<div
  class="mx-auto max-w-4xl p-6 space-y-6 bg-white/70 backdrop-blur rounded-xl shadow-sm border border-slate-200"
>
  <app-exam-header [takenExam]="takenExamSig">
    <app-exam-progress
      [answered]="answeredCount()"
      [total]="examItemsSig.length"
    />
  </app-exam-header>

  <!-- Exam Timer Component -->
  @if (timerData) {
    <app-exam-timer
      [examData]="timerData"
      (timeExpired)="onTimeExpired()"
    />
  }

  @if (examItemsSig.length) {
  <div class="space-y-6">
    @for (item of examItemsSig; track item.id; let idx = $index) {
    <app-exam-question
      [item]="item"
      [index]="idx"
      [currentAnswer]="answers()[item.id]"
      (answerChange)="onAnswerChange(item, $event)"
      [isReadonlySig]="wasSubmitted()"
    />
    }
  </div>
  } @else {
  <p class="text-slate-500 italic">No items available for this exam.</p>
  }

  <div class="flex items-center justify-between pt-2">
    @if (examItemsSig.length) {
    <div class="text-sm text-slate-500">
      Answered {{ answeredCount() }} of {{ examItemsSig.length }}
    </div>
    } @if (!wasSubmitted()) {

    <button
      (click)="submit()"
      [disabled]="submitting() || !examItemsSig.length"
      class="inline-flex items-center gap-2 rounded-lg bg-indigo-600 text-white text-sm font-medium px-6 py-3 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2 transition"
    >
      @if (!submitting()) { <span>Submit Exam</span> } @else {
      <svg class="size-4 animate-spin" viewBox="0 0 24 24">
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
          fill="none"
        />
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
        />
      </svg>
      <span>Submitting...</span> }
    </button>
    }
  </div>

  @if (error()) {
  <div
    class="rounded-md border border-rose-200 bg-rose-50 text-rose-700 px-4 py-2 text-sm"
  >
    {{ error() }}
  </div>
  }
</div>
} @else {
<div
  class="max-w-md mx-auto mt-16 flex flex-col items-center gap-4 text-slate-500"
>
  <svg
    class="size-10 animate-pulse text-slate-400"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="1.5"
  >
    <path d="M12 6v6l4 2" stroke-linecap="round" stroke-linejoin="round" />
  </svg>
  <p>Loading exam...</p>
</div>
}
