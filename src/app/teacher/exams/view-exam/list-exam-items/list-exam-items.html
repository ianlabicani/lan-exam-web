@let exam = viewExamSvc.viewingExam();

@if (exam) {
  <div class="space-y-6">
    <!-- Topics Loop -->
    @for (topic of exam.tos; track $index) {
      @let topicIndex = $index;

      <div class="rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden">
        <!-- Topic Header / Collapsible Button -->
        <button
          type="button"
          (click)="toggleTopic(topicIndex)"
          class="w-full flex items-center justify-between px-6 py-4 bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 transition border-b border-gray-200">
          <div class="flex items-center gap-3">
            <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-600 text-white text-sm font-bold">{{ topicIndex + 1 }}</span>
            <div class="text-left">
              <h3 class="text-lg font-semibold text-gray-900">{{ topic.topic }}</h3>
              <p class="text-xs text-gray-600">{{ topic.no_of_items }} questions • {{ topic.time_allotment }} hours</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-white rounded-full text-sm font-medium text-blue-700">
              {{ isTopicExpanded(topicIndex) ? '−' : '+' }}
            </span>
          </div>
        </button>

        <!-- Topic Content -->
        @if (isTopicExpanded(topicIndex)) {
          <div class="p-6 space-y-6">
            <!-- Easy Difficulty Section -->
            <div class="rounded-lg border border-green-200 bg-green-50 overflow-hidden">
              <div class="px-4 py-3 bg-green-100 border-b border-green-200">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-green-600 text-white text-xs font-bold">E</span>
                    <h4 class="text-sm font-semibold text-gray-900">Easy</h4>
                    <span class="text-xs text-gray-600">{{ getItemsByTopicAndLevel(topic.topic, 'easy').length }} / {{ topic.distribution.easy.allocation }}</span>
                  </div>
                </div>
              </div>
              <div class="p-4 space-y-3">
                <!-- Add Easy Button -->
                @if (exam?.status === 'draft' && topic.distribution.easy.allocation > getItemsByTopicAndLevel(topic.topic, 'easy').length) {
                  <button
                    (click)="openAddQuestionModal('easy')"
                    type="button"
                    class="w-full px-3 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition">
                    + Add Easy Question
                  </button>

                  <!-- Easy Modals -->
                  <app-mcq-form-modal [examId]="exam.id" [level]="'easy'" [topic]="topic.topic" (openModal)="isEasyMcqModalOpen.set(true)" (closeModal)="isEasyMcqModalOpen.set(false)" [isModalOpen]="isEasyMcqModalOpen()"></app-mcq-form-modal>
                  <app-true-or-false-form-modal [examId]="exam.id" [level]="'easy'" [topic]="topic.topic" (openModal)="isEasyTOFModalOpen.set(true)" (closeModal)="isEasyTOFModalOpen.set(false)" [isModalOpen]="isEasyTOFModalOpen()"></app-true-or-false-form-modal>
                  <app-essay-form-modal [examId]="exam.id" [level]="'easy'" [topic]="topic.topic" (openModal)="isEasyEssayModalOpen.set(true)" (closeModal)="isEasyEssayModalOpen.set(false)" [isModalOpen]="isEasyEssayModalOpen()"></app-essay-form-modal>
                  <app-fill-blank-form-modal [examId]="exam.id" [level]="'easy'" [topic]="topic.topic" (openModal)="isEasyFillBlankModalOpen.set(true)" (closeModal)="isEasyFillBlankModalOpen.set(false)" [isModalOpen]="isEasyFillBlankModalOpen()"></app-fill-blank-form-modal>
                  <app-short-answer-form-modal [examId]="exam.id" [level]="'easy'" [topic]="topic.topic" (openModal)="isEasyShortAnswerModalOpen.set(true)" (closeModal)="isEasyShortAnswerModalOpen.set(false)" [isModalOpen]="isEasyShortAnswerModalOpen()"></app-short-answer-form-modal>
                  <app-matching-form-modal [examId]="exam.id" [level]="'easy'" [topic]="topic.topic" (openModal)="isEasyMatchingModalOpen.set(true)" (closeModal)="isEasyMatchingModalOpen.set(false)" [isModalOpen]="isEasyMatchingModalOpen()"></app-matching-form-modal>
                }

                <!-- Easy Items List -->
                @if (getItemsByTopicAndLevel(topic.topic, 'easy').length > 0) {
                  <div class="space-y-2">
                    @for(item of getItemsByTopicAndLevel(topic.topic, 'easy'); track item.id) {
                      <div class="border border-green-200 rounded-lg p-3 bg-white hover:border-green-400 hover:bg-green-50 transition">
                        <!-- Edit/Delete Actions -->
                        @if (exam?.status === 'draft') {
                          <div class="flex justify-end gap-2 mb-2">
                            <button (click)="openEditModal(item)" class="text-xs font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded transition">Edit</button>
                            <button (click)="openDeleteModal(item)" class="text-xs font-medium text-red-600 hover:text-red-800 hover:bg-red-50 px-2 py-1 rounded transition">Delete</button>
                          </div>
                        }
                        <!-- Item Display -->
                        @if(item.type === 'mcq') {
                          <app-mcq-item [item]="item"></app-mcq-item>
                        } @else if(item.type === 'truefalse') {
                          <app-true-false-item [itemSig]="item"></app-true-false-item>
                        } @else if(item.type === 'essay') {
                          <app-essay-item [itemSig]="item"></app-essay-item>
                        } @else if(item.type === 'fillblank') {
                          <app-fill-blank-item [itemSig]="item"></app-fill-blank-item>
                        } @else if(item.type === 'shortanswer') {
                          <app-short-answer-item [itemSig]="item"></app-short-answer-item>
                        } @else if(item.type === 'matching') {
                          <app-matching-item [itemSig]="item"></app-matching-item>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>

            <!-- Moderate Difficulty Section -->
            <div class="rounded-lg border border-yellow-200 bg-yellow-50 overflow-hidden">
              <div class="px-4 py-3 bg-yellow-100 border-b border-yellow-200">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-yellow-600 text-white text-xs font-bold">M</span>
                    <h4 class="text-sm font-semibold text-gray-900">Moderate</h4>
                    <span class="text-xs text-gray-600">{{ getItemsByTopicAndLevel(topic.topic, 'moderate').length }} / {{ topic.distribution.moderate.allocation }}</span>
                  </div>
                </div>
              </div>
              <div class="p-4 space-y-3">
                <!-- Add Moderate Button -->
                @if (exam?.status === 'draft' && topic.distribution.moderate.allocation > getItemsByTopicAndLevel(topic.topic, 'moderate').length) {
                  <button
                    (click)="openAddQuestionModal('moderate')"
                    type="button"
                    class="w-full px-3 py-2 bg-yellow-600 text-white text-sm font-medium rounded-lg hover:bg-yellow-700 transition">
                    + Add Moderate Question
                  </button>

                  <!-- Moderate Modals -->
                  <app-mcq-form-modal [examId]="exam.id" [level]="'moderate'" [topic]="topic.topic" (openModal)="isModerateMcqModalOpen.set(true)" (closeModal)="isModerateMcqModalOpen.set(false)" [isModalOpen]="isModerateMcqModalOpen()"></app-mcq-form-modal>
                  <app-true-or-false-form-modal [examId]="exam.id" [level]="'moderate'" [topic]="topic.topic" (openModal)="isModerateTOFModalOpen.set(true)" (closeModal)="isModerateTOFModalOpen.set(false)" [isModalOpen]="isModerateTOFModalOpen()"></app-true-or-false-form-modal>
                  <app-essay-form-modal [examId]="exam.id" [level]="'moderate'" [topic]="topic.topic" (openModal)="isModerateEssayModalOpen.set(true)" (closeModal)="isModerateEssayModalOpen.set(false)" [isModalOpen]="isModerateEssayModalOpen()"></app-essay-form-modal>
                  <app-fill-blank-form-modal [examId]="exam.id" [level]="'moderate'" [topic]="topic.topic" (openModal)="isModerateFillBlankModalOpen.set(true)" (closeModal)="isModerateFillBlankModalOpen.set(false)" [isModalOpen]="isModerateFillBlankModalOpen()"></app-fill-blank-form-modal>
                  <app-short-answer-form-modal [examId]="exam.id" [level]="'moderate'" [topic]="topic.topic" (openModal)="isModerateShortAnswerModalOpen.set(true)" (closeModal)="isModerateShortAnswerModalOpen.set(false)" [isModalOpen]="isModerateShortAnswerModalOpen()"></app-short-answer-form-modal>
                  <app-matching-form-modal [examId]="exam.id" [level]="'moderate'" [topic]="topic.topic" (openModal)="isModerateMatchingModalOpen.set(true)" (closeModal)="isModerateMatchingModalOpen.set(false)" [isModalOpen]="isModerateMatchingModalOpen()"></app-matching-form-modal>
                }

                <!-- Moderate Items List -->
                @if (getItemsByTopicAndLevel(topic.topic, 'moderate').length > 0) {
                  <div class="space-y-2">
                    @for(item of getItemsByTopicAndLevel(topic.topic, 'moderate'); track item.id) {
                      <div class="border border-yellow-200 rounded-lg p-3 bg-white hover:border-yellow-400 hover:bg-yellow-50 transition">
                        <!-- Edit/Delete Actions -->
                        @if (exam?.status === 'draft') {
                          <div class="flex justify-end gap-2 mb-2">
                            <button (click)="openEditModal(item)" class="text-xs font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded transition">Edit</button>
                            <button (click)="openDeleteModal(item)" class="text-xs font-medium text-red-600 hover:text-red-800 hover:bg-red-50 px-2 py-1 rounded transition">Delete</button>
                          </div>
                        }
                        <!-- Item Display -->
                        @if(item.type === 'mcq') {
                          <app-mcq-item [item]="item"></app-mcq-item>
                        } @else if(item.type === 'truefalse') {
                          <app-true-false-item [itemSig]="item"></app-true-false-item>
                        } @else if(item.type === 'essay') {
                          <app-essay-item [itemSig]="item"></app-essay-item>
                        } @else if(item.type === 'fillblank') {
                          <app-fill-blank-item [itemSig]="item"></app-fill-blank-item>
                        } @else if(item.type === 'shortanswer') {
                          <app-short-answer-item [itemSig]="item"></app-short-answer-item>
                        } @else if(item.type === 'matching') {
                          <app-matching-item [itemSig]="item"></app-matching-item>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>

            <!-- Difficult Difficulty Section -->
            <div class="rounded-lg border border-red-200 bg-red-50 overflow-hidden">
              <div class="px-4 py-3 bg-red-100 border-b border-red-200">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center justify-center h-6 w-6 rounded-full bg-red-600 text-white text-xs font-bold">D</span>
                    <h4 class="text-sm font-semibold text-gray-900">Difficult</h4>
                    <span class="text-xs text-gray-600">{{ getItemsByTopicAndLevel(topic.topic, 'difficult').length }} / {{ topic.distribution.difficult.allocation }}</span>
                  </div>
                </div>
              </div>
              <div class="p-4 space-y-3">
                <!-- Add Difficult Button -->
                @if (exam?.status === 'draft' && topic.distribution.difficult.allocation > getItemsByTopicAndLevel(topic.topic, 'difficult').length) {
                  <button
                    (click)="openAddQuestionModal('difficult')"
                    type="button"
                    class="w-full px-3 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition">
                    + Add Difficult Question
                  </button>

                  <!-- Difficult Modals -->
                  <app-mcq-form-modal [examId]="exam.id" [level]="'difficult'" [topic]="topic.topic" (openModal)="isDifficultMcqModalOpen.set(true)" (closeModal)="isDifficultMcqModalOpen.set(false)" [isModalOpen]="isDifficultMcqModalOpen()"></app-mcq-form-modal>
                  <app-true-or-false-form-modal [examId]="exam.id" [level]="'difficult'" [topic]="topic.topic" (openModal)="isDifficultTOFModalOpen.set(true)" (closeModal)="isDifficultTOFModalOpen.set(false)" [isModalOpen]="isDifficultTOFModalOpen()"></app-true-or-false-form-modal>
                  <app-essay-form-modal [examId]="exam.id" [level]="'difficult'" [topic]="topic.topic" (openModal)="isDifficultEssayModalOpen.set(true)" (closeModal)="isDifficultEssayModalOpen.set(false)" [isModalOpen]="isDifficultEssayModalOpen()"></app-essay-form-modal>
                  <app-fill-blank-form-modal [examId]="exam.id" [level]="'difficult'" [topic]="topic.topic" (openModal)="isDifficultFillBlankModalOpen.set(true)" (closeModal)="isDifficultFillBlankModalOpen.set(false)" [isModalOpen]="isDifficultFillBlankModalOpen()"></app-fill-blank-form-modal>
                  <app-short-answer-form-modal [examId]="exam.id" [level]="'difficult'" [topic]="topic.topic" (openModal)="isDifficultShortAnswerModalOpen.set(true)" (closeModal)="isDifficultShortAnswerModalOpen.set(false)" [isModalOpen]="isDifficultShortAnswerModalOpen()"></app-short-answer-form-modal>
                  <app-matching-form-modal [examId]="exam.id" [level]="'difficult'" [topic]="topic.topic" (openModal)="isDifficultMatchingModalOpen.set(true)" (closeModal)="isDifficultMatchingModalOpen.set(false)" [isModalOpen]="isDifficultMatchingModalOpen()"></app-matching-form-modal>
                }

                <!-- Difficult Items List -->
                @if (getItemsByTopicAndLevel(topic.topic, 'difficult').length > 0) {
                  <div class="space-y-2">
                    @for(item of getItemsByTopicAndLevel(topic.topic, 'difficult'); track item.id) {
                      <div class="border border-red-200 rounded-lg p-3 bg-white hover:border-red-400 hover:bg-red-50 transition">
                        <!-- Edit/Delete Actions -->
                        @if (exam?.status === 'draft') {
                          <div class="flex justify-end gap-2 mb-2">
                            <button (click)="openEditModal(item)" class="text-xs font-medium text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded transition">Edit</button>
                            <button (click)="openDeleteModal(item)" class="text-xs font-medium text-red-600 hover:text-red-800 hover:bg-red-50 px-2 py-1 rounded transition">Delete</button>
                          </div>
                        }
                        <!-- Item Display -->
                        @if(item.type === 'mcq') {
                          <app-mcq-item [item]="item"></app-mcq-item>
                        } @else if(item.type === 'truefalse') {
                          <app-true-false-item [itemSig]="item"></app-true-false-item>
                        } @else if(item.type === 'essay') {
                          <app-essay-item [itemSig]="item"></app-essay-item>
                        } @else if(item.type === 'fillblank') {
                          <app-fill-blank-item [itemSig]="item"></app-fill-blank-item>
                        } @else if(item.type === 'shortanswer') {
                          <app-short-answer-item [itemSig]="item"></app-short-answer-item>
                        } @else if(item.type === 'matching') {
                          <app-matching-item [itemSig]="item"></app-matching-item>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Add Question Modal -->
  <app-add-question-modal
    [isOpen]="addQuestionModalLevel() !== null"
    [level]="addQuestionModalLevel() || 'easy'"
    (typeSelected)="onQuestionTypeSelected($event)"
    (closeModal)="closeAddQuestionModal()"></app-add-question-modal>

  <!-- Delete Modal -->
  @if (isDeleteModalOpenSig()) {
    <app-delete-item [itemInput]="selectedForUpdateSig()!" [exam]="exam!" (close)="closeDeleteModal()"></app-delete-item>
  }

  <!-- Edit Modals (with itemToEdit for all types) -->
  <app-mcq-form-modal
    [examId]="selectedForUpdateSig()?.exam_id ?? 0"
    [topic]="selectedForUpdateSig()?.topic ?? ''"
    [isModalOpen]="isEditingItemType('mcq')"
    [itemToEdit]="selectedForUpdateSig()"
    (closeModal)="closeEditModal()"
    (itemSaved)="closeEditModal()">
  </app-mcq-form-modal>

  <app-true-or-false-form-modal
    [examId]="selectedForUpdateSig()?.exam_id ?? 0"
    [topic]="selectedForUpdateSig()?.topic ?? ''"
    [isModalOpen]="isEditingItemType('truefalse')"
    [itemToEdit]="selectedForUpdateSig()"
    (closeModal)="closeEditModal()"
    (itemSaved)="closeEditModal()">
  </app-true-or-false-form-modal>

  <app-essay-form-modal
    [examId]="selectedForUpdateSig()?.exam_id ?? 0"
    [topic]="selectedForUpdateSig()?.topic ?? ''"
    [isModalOpen]="isEditingItemType('essay')"
    [itemToEdit]="selectedForUpdateSig()"
    (closeModal)="closeEditModal()"
    (itemSaved)="closeEditModal()">
  </app-essay-form-modal>

  <app-fill-blank-form-modal
    [examId]="selectedForUpdateSig()?.exam_id ?? 0"
    [topic]="selectedForUpdateSig()?.topic ?? ''"
    [isModalOpen]="isEditingItemType('fillblank')"
    [itemToEdit]="selectedForUpdateSig()"
    (closeModal)="closeEditModal()"
    (itemSaved)="closeEditModal()">
  </app-fill-blank-form-modal>

  <app-short-answer-form-modal
    [examId]="selectedForUpdateSig()?.exam_id ?? 0"
    [topic]="selectedForUpdateSig()?.topic ?? ''"
    [isModalOpen]="isEditingItemType('shortanswer')"
    [itemToEdit]="selectedForUpdateSig()"
    (closeModal)="closeEditModal()"
    (itemSaved)="closeEditModal()">
  </app-short-answer-form-modal>

  <app-matching-form-modal
    [examId]="selectedForUpdateSig()?.exam_id ?? 0"
    [topic]="selectedForUpdateSig()?.topic ?? ''"
    [isModalOpen]="isEditingItemType('matching')"
    [itemToEdit]="selectedForUpdateSig()"
    (closeModal)="closeEditModal()"
    (itemSaved)="closeEditModal()">
  </app-matching-form-modal>
}
