@let studentPairs = parseJson(answer().answer);
@let expectedPairs = comparison() ? parseJson(comparison().correct_answer) : null;

@if (studentPairs && isArrayType(studentPairs) && expectedPairs && isArrayType(expectedPairs)) {
  <!-- Header Row -->
  <div class="mb-3 px-4 py-2 bg-slate-100 rounded-lg flex items-center justify-between text-xs font-semibold text-slate-700">
    <div class="flex-1 text-center">Left</div>
    <fa-icon [icon]="faArrowRight" class="text-slate-400 text-xs mx-4"></fa-icon>
    <div class="flex-1 text-center">Student Answer</div>
    <fa-icon [icon]="faArrowRight" class="text-slate-400 text-xs mx-4"></fa-icon>
    <div class="flex-1 text-center">Correct Answer</div>
  </div>

  <!-- Match Rows -->
  <div class="space-y-2">
    @for (pair of studentPairs; track $index) {
      @let isCorrect = isCorrectMatch(pair, expectedPairs);
      @let correctRight = getCorrectRightValue(pair.left, expectedPairs);

      <div class="flex items-center justify-between px-4 py-3 rounded-lg border"
           [ngClass]="isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'">
        <!-- Left -->
        <div class="flex-1 text-center text-sm font-medium text-slate-700">{{ pair.left }}</div>

        <!-- Arrow -->
        <fa-icon [icon]="faArrowRight" class="text-slate-400 text-xs mx-4"></fa-icon>

        <!-- Student Answer -->
        <div class="flex-1 text-center text-sm font-medium"
             [ngClass]="isCorrect ? 'text-slate-700' : 'text-red-700'">
          {{ pair.right }}
        </div>

        <!-- Arrow -->
        <fa-icon [icon]="faArrowRight" class="text-slate-400 text-xs mx-4"></fa-icon>

        <!-- Correct Answer -->
        <div class="flex-1 text-center text-sm font-medium text-green-700">{{ correctRight }}</div>

        <!-- Status Icon -->
        <div class="ml-4">
          @if (isCorrect) {
            <fa-icon [icon]="faCheckCircle" class="text-green-600 text-lg"></fa-icon>
          } @else {
            <fa-icon [icon]="faTimesCircle" class="text-red-600 text-lg"></fa-icon>
          }
        </div>
      </div>
    }
  </div>
}

<!-- Status Box -->
@if (comparison()) {
  <div class="mt-4 p-3 rounded-lg"
       [ngClass]="{
         'bg-green-50 border border-green-200': comparison().is_correct,
         'bg-red-50 border border-red-200': comparison().is_correct === false,
         'bg-amber-50 border border-amber-200': comparison().is_correct === null
       }">
    <div class="text-sm font-medium">
      @if (comparison().is_correct === true) {
        <span class="text-green-700">✓ All matches correct</span>
      } @else if (comparison().is_correct === false) {
        <span class="text-red-700">✗ Some matches incorrect</span>
      } @else {
        <span class="text-amber-700">⚠ Manual review required</span>
      }
    </div>
  </div>
}
