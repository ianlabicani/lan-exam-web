@let examSig = this.examService.viewingExam();
@let loading = loadingSig();
@let errorMsgSig = errorMsg();


@if (errorMsgSig) {
  <div class="fixed right-4 top-4 z-50 w-[calc(100%-2rem)] max-w-md pointer-events-none">
    <div
      class="pointer-events-auto rounded-md border border-red-200 bg-red-50 p-4 text-red-700 shadow-lg"
      role="alert"
    >
      <div class="flex items-start gap-3">
        <span class="text-xl leading-none">⚠️</span>
        <div>
          <p class="font-semibold">Error</p>
          <p class="text-sm break-words">{{ errorMsgSig }}</p>
        </div>
      </div>
    </div>
  </div>
}

@if (loading) {
<span class="p-10 text-center text-gray-500">Loading exam...</span>
} @else {
  <div class="space-y-6 container mx-auto mt-10 px-6">
  @if(examSig) {
    <div class="flex justify-between">
      <a routerLink="/teacher/exams" class="px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200 text-sm font-medium">
        <fa-icon [icon]="faArrowLeft" class="mr-1"></fa-icon>
        Back
      </a>
      @if(examSig.status === 'draft') {
      <span class="px-2 py-1 bg-gray-100 rounded font-medium">Draft (editable)</span>
      } @else {
      <span class="px-2 py-1 bg-gray-100 rounded font-medium">Read Only</span>
      }
    </div>

  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
    <div>
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-2xl font-bold text-gray-900">{{ examSig.title }}</h1>
        <span class="px-2 py-0.5 text-xs font-semibold rounded-full tracking-wide uppercase {{ statusBadge(examSig?.status) }}">
          {{ examSig.status }}
        </span>
      </div>
      <p class="text-sm text-gray-600 max-w-prose">{{ examSig.description }}</p>
      <div class="mt-3 flex flex-wrap gap-4 text-xs text-gray-500">
        <span>Starts: {{ examSig.starts_at | date:'medium' }}</span>
        <span>Ends: {{ examSig.ends_at | date:'medium' }}</span>
        <span>Created: {{ examSig.created_at | date:'short' }}</span>
        <span>Updated: {{ examSig.updated_at | date:'short' }}</span>
        <span>Year {{ examSig.year }}</span>
        <span class="flex items-center gap-1">
          <span>Sections:</span>
          @if (examSig.sections?.length) {
            <span class="flex flex-wrap gap-1">
              @for (s of examSig.sections; track $index) {
                <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 uppercase">{{ s }}</span>
              }
            </span>
          } @else if (examSig.section) {
            <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 uppercase">{{ examSig.section }}</span>
          }
        </span>
      </div>
      <p>Points {{ examSig.total_points }}</p>
    </div>
    <div class="flex items-center gap-2 self-start">
      @if (examSig.status == 'draft' ) {
      <div>
        <button
          type="button"
          class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 text-sm font-medium disabled:opacity-50"
          [ngClass]="{ 'opacity-50 cursor-not-allowed': examSig.total_points <= 0 }"
          [disabled]="loading || examSig.total_points <= 0"
          (click)="updateStatus(examSig.id, 'active')"
        >
          Activate Exam
        </button>
      </div>
    }

    @if (examSig.status == 'active') {
      <div>
        <button
          type="button"
          class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 text-sm font-medium disabled:opacity-50"
          [disabled]="loading"
          (click)="updateStatus(examSig.id, 'published')"
        >
          Publish Exam
        </button>
      </div>
    }

    @if (examSig.status == 'published') {
      <div>
        <button
          type="button"
          class="px-4 py-2 rounded bg-red-600 text-white hover:bg-green-700 text-sm font-medium disabled:opacity-50"
          [disabled]="loading"
          (click)="updateStatus(examSig.id, 'archived')"
        >
          Archive Exam
        </button>
      </div>
    }
    </div>
  </div>

  <div class="flex gap-4 mt-6">
    @if (examSig.status === 'published') {
    <a [routerLink]="['./items']" class="px-4 py-2 rounded bg-green-100 hover:bg-green-200 text-sm font-medium">
      View Items
    </a>

    }

    @if (examSig.status === 'published') {
    <a [routerLink]="['./takers']" class="px-4 py-2 rounded bg-blue-100 hover:bg-blue-200 text-sm font-medium" >
      View Takers
    </a>
    }
  </div>

  <!-- TOS Display -->
  @if (examSig?.tos?.length) {
    <div class="mt-8 space-y-4">
      <div class="rounded-lg border bg-white p-4">
        <h3 class="text-lg font-semibold text-gray-800">Table of Specifications</h3>
      </div>
      @for (t of examSig.tos; track $index) {
        <div class="rounded-lg border bg-white p-4 space-y-3">
          <div class="flex items-center justify-between">
            <h4 class="text-base font-semibold text-gray-800">Topic: <span class="font-normal">{{ t.topic }}</span></h4>
          </div>
          @if (t.outcomes.length) {
            <div>
              <p class="text-xs font-semibold text-gray-600 mb-1">Outcomes</p>
              <ul class="list-disc pl-5 text-sm text-gray-700 space-y-0.5">
                @for (o of t.outcomes; track $index) {
                  <li>{{ o }}</li>
                }
              </ul>
            </div>
          }
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
            <div><span class="text-gray-500">Time Allotment:</span> <span class="font-medium text-gray-800">{{ t.time_allotment }}</span></div>
            <div><span class="text-gray-500">No. of Items:</span> <span class="font-medium text-gray-800">{{ t.no_of_items }}</span></div>
          </div>

          @if (t.distribution) {
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <!-- Easy -->
              <div class="rounded border p-3 bg-gray-50">
                <p class="text-xs font-semibold text-gray-700 mb-2">Easy</p>
                <p class="text-xs text-gray-600 mb-1">Allocation: <span class="font-medium text-gray-800">{{ t.distribution.easy.allocation }}</span></p>
                @if (t.distribution.easy.placement.length) {
                  <div class="flex flex-wrap gap-1">
                    @for (p of t.distribution.easy.placement; track $index) {
                      <span class="px-2 py-0.5 rounded bg-white border text-xs">{{ p }}</span>
                    }
                  </div>
                }
              </div>
              <!-- Moderate -->
              <div class="rounded border p-3 bg-gray-50">
                <p class="text-xs font-semibold text-gray-700 mb-2">Moderate</p>
                <p class="text-xs text-gray-600 mb-1">Allocation: <span class="font-medium text-gray-800">{{ t.distribution.moderate.allocation }}</span></p>
                @if (t.distribution.moderate.placement.length) {
                  <div class="flex flex-wrap gap-1">
                    @for (p of t.distribution.moderate.placement; track $index) {
                      <span class="px-2 py-0.5 rounded bg-white border text-xs">{{ p }}</span>
                    }
                  </div>
                }
              </div>
              <!-- Difficult -->
              <div class="rounded border p-3 bg-gray-50">
                <p class="text-xs font-semibold text-gray-700 mb-2">Difficult</p>
                <p class="text-xs text-gray-600 mb-1">Allocation: <span class="font-medium text-gray-800">{{ t.distribution.difficult.allocation }}</span></p>
                @if (t.distribution.difficult.placement.length) {
                  <div class="flex flex-wrap gap-1">
                    @for (p of t.distribution.difficult.placement; track $index) {
                      <span class="px-2 py-0.5 rounded bg-white border text-xs">{{ p }}</span>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <div class="space-y-8">
    <router-outlet/>
  </div>
  }

  @if(!examSig) {
  <div class="p-10 border border-dashed rounded-lg text-center bg-white">
    <p class="text-gray-600 font-medium mb-2">Exam not found</p>
    <a routerLink="/teacher/exams" class="text-sm text-blue-600 hover:underline">
      Return to exams list
    </a>
  </div>
  }

</div>
}
