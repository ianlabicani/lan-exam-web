@let examSig = exam();
@let loadingSig = loading();
@let errorMsgSig = errorMsg();
@let showTabsSig = showTabs();

@if (loadingSig) {
  <div class="flex items-center justify-center min-h-screen bg-gray-50">
    <div class="space-y-3 text-center">
      <div class="inline-block animate-spin">
        <fa-icon [icon]="faSync" class="text-3xl text-indigo-600"></fa-icon>
      </div>
      <p class="text-gray-600 font-medium">Loading exam...</p>
    </div>
  </div>
}

@if (errorMsgSig) {
  <div class="fixed right-4 top-4 z-50 w-[calc(100%-2rem)] max-w-md pointer-events-none">
    <div
      class="pointer-events-auto rounded-lg border border-red-200 bg-red-50 p-4 text-red-700 shadow-lg animate-in fade-in slide-in-from-top-2 duration-300"
      role="alert"
    >
      <div class="flex items-start gap-3">
        <fa-icon [icon]="faExclamationCircle" class="mt-0.5 flex-shrink-0"></fa-icon>
        <div>
          <p class="font-semibold">Error</p>
          <p class="text-sm break-words">{{ errorMsgSig }}</p>
        </div>
      </div>
    </div>
  </div>
}

@if(examSig) {
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

      <!-- Page Header -->
      <div class="mb-8">
        <div class="flex items-center justify-between mb-6">
          <a routerLink="/teacher/exams" class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition">
            <fa-icon [icon]="faArrowLeft" class="text-lg"></fa-icon>
            <span>Back to Exams</span>
          </a>
          @if(examSig.status === 'draft') {
            <span class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">Draft (editable)</span>
          } @else {
            <span class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">Read Only</span>
          }
        </div>

        <!-- Title and Status -->
        <div class="flex items-center gap-3 mb-4">
          <h1 class="text-3xl font-bold text-gray-900">{{ examSig.title }}</h1>
          <span
            [class]="'px-3 py-1 text-xs font-semibold rounded-full tracking-wide uppercase ' + statusBadgeClass()">
            {{ examSig.status }}
          </span>
        </div>

        <p class="text-gray-600 max-w-prose mb-4">{{ examSig.description }}</p>

        <!-- Meta Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-lg shadow-sm p-3 border border-gray-200">
            <p class="text-xs text-gray-500 font-semibold">Starts</p>
            <p class="text-sm font-medium text-gray-900">{{ examSig.starts_at | date:'medium' }}</p>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-3 border border-gray-200">
            <p class="text-xs text-gray-500 font-semibold">Ends</p>
            <p class="text-sm font-medium text-gray-900">{{ examSig.ends_at | date:'medium' }}</p>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-3 border border-gray-200">
            <p class="text-xs text-gray-500 font-semibold">Total Points</p>
            <p class="text-sm font-medium text-gray-900">{{ examSig.total_points }}</p>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-3 border border-gray-200">
            <p class="text-xs text-gray-500 font-semibold">Years & Sections</p>
            <p class="text-sm font-medium text-gray-900">
              Year {{ examSig.year | json }} | Section {{ examSig.sections | json }}
            </p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-3">
          @if (examSig.status === 'draft') {
            <button
              type="button"
              (click)="updateStatus(examSig.id, 'active')"
              [disabled]="saving() || examSig.total_points <= 0"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
              <fa-icon [icon]="faCheckCircle"></fa-icon>
              {{ saving() ? 'Activating...' : 'Activate Exam' }}
            </button>
          }

          @if (examSig.status === 'active') {
            <button
              type="button"
              (click)="updateStatus(examSig.id, 'published')"
              [disabled]="saving()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-green-600 text-white text-sm font-medium hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
              <fa-icon [icon]="faCheckCircle"></fa-icon>
              {{ saving() ? 'Publishing...' : 'Publish Exam' }}
            </button>
          }

          @if (examSig.status === 'published') {
            <button
              type="button"
              (click)="updateStatus(examSig.id, 'archived')"
              [disabled]="saving()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-red-600 text-white text-sm font-medium hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
              <fa-icon [icon]="faTimes"></fa-icon>
              {{ saving() ? 'Archiving...' : 'Archive Exam' }}
            </button>
          }
        </div>
      </div>

      <!-- Content Sections -->
      @if (showTabsSig) {
        <!-- Tab Navigation -->
        <div class="bg-white rounded-t-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="border-b border-gray-200">
            <nav class="flex">
              <a
                [routerLink]="['overview']"
                routerLinkActive="border-indigo-500 text-indigo-600"
                class="flex-1 px-6 py-4 text-sm font-medium transition border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer text-center">
                Overview
              </a>
              <a
                [routerLink]="['items']"
                routerLinkActive="border-indigo-500 text-indigo-600"
                class="flex-1 px-6 py-4 text-sm font-medium transition border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer text-center">
                Questions
              </a>
              <a
                [routerLink]="['takers']"
                routerLinkActive="border-indigo-500 text-indigo-600"
                class="flex-1 px-6 py-4 text-sm font-medium transition border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer text-center">
                Takers
              </a>
              <a
                [routerLink]="['analytics']"
                routerLinkActive="border-indigo-500 text-indigo-600"
                class="flex-1 px-6 py-4 text-sm font-medium transition border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer text-center">
                Analytics
              </a>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="p-6">
            <div class="space-y-4">
              <router-outlet></router-outlet>
            </div>
          </div>
        </div>
      } @else {
        <!-- No tabs for draft exams - show TOS directly -->
        @if (examSig?.tos?.length) {
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-4">
            <div class="flex items-center gap-2 mb-6">
              <h2 class="text-xl font-bold text-gray-900">Table of Specifications</h2>
              <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">
                {{ examSig.tos?.length }} Topics
              </span>
            </div>

            @for (t of examSig.tos; track $index) {
              <div class="rounded-lg border border-gray-200 bg-gray-50 p-6 space-y-4">
                <!-- Topic Header -->
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{{ t.topic }}</h3>
                </div>

                <!-- Outcomes -->
                @if (t.outcomes && t.outcomes.length) {
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-2">Learning Outcomes</p>
                    <ul class="list-disc pl-5 space-y-1">
                      @for (o of t.outcomes; track $index) {
                        <li class="text-sm text-gray-700">{{ o }}</li>
                      }
                    </ul>
                  </div>
                }

                <!-- Time and Items Info -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 bg-white rounded p-4">
                  <div>
                    <p class="text-xs text-gray-600 font-semibold">Time Allotment</p>
                    <p class="text-sm font-medium text-gray-900">{{ t.time_allotment }} minutes</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-600 font-semibold">No. of Items</p>
                    <p class="text-sm font-medium text-gray-900">{{ t.no_of_items }} items</p>
                  </div>
                </div>

                <!-- Distribution by Difficulty -->
                @if (t.distribution) {
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-3">Distribution by Difficulty</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <!-- Easy -->
                      <div class="rounded-lg border border-gray-300 p-4 bg-white hover:border-green-300 hover:bg-green-50 transition">
                        <p class="text-sm font-semibold text-gray-900 mb-2">Easy</p>
                        <p class="text-xs text-gray-600">Allocation: <span class="font-bold text-gray-900">{{ t.distribution.easy.allocation || 0 }}</span></p>
                      </div>

                      <!-- Moderate -->
                      <div class="rounded-lg border border-gray-300 p-4 bg-white hover:border-yellow-300 hover:bg-yellow-50 transition">
                        <p class="text-sm font-semibold text-gray-900 mb-2">Moderate</p>
                        <p class="text-xs text-gray-600">Allocation: <span class="font-bold text-gray-900">{{ t.distribution.moderate.allocation || 0 }}</span></p>
                      </div>

                      <!-- Difficult -->
                      <div class="rounded-lg border border-gray-300 p-4 bg-white hover:border-red-300 hover:bg-red-50 transition">
                        <p class="text-sm font-semibold text-gray-900 mb-2">Difficult</p>
                        <p class="text-xs text-gray-600">Allocation: <span class="font-bold text-gray-900">{{ t.distribution.difficult.allocation || 0 }}</span></p>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      }

    </div>
  </div>
}
