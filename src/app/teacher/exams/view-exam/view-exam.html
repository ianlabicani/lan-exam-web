@let examSig = exam();
@let loadingSig = loading();
@let errorMsgSig = errorMsg();
@let showTabsSig = showTabs();

<!-- Delete Exam Modal -->
<app-delete-exam-modal
  [examTitle]="examSig?.title || ''"
  [isOpen]="showDeleteModal()"
  [isDeleting]="isDeleting()"
  (closeModal)="closeDeleteModal()"
  (confirmDelete)="submitDelete()"
></app-delete-exam-modal>

<!-- Status Update Modal -->
<app-status-update-modal
  [exam]="examSig"
  [isOpen]="showStatusModal()"
  [isSaving]="saving()"
  (closeModal)="closeStatusModal()"
  (submitStatusUpdate)="submitStatusUpdate($event)"
></app-status-update-modal>

@if (loadingSig) {
  <div class="flex items-center justify-center min-h-screen bg-gray-50">
    <div class="space-y-3 text-center">
      <div class="inline-block animate-spin">
        <fa-icon [icon]="faSync" class="text-3xl text-indigo-600"></fa-icon>
      </div>
      <p class="text-gray-600 font-medium">Loading exam...</p>
    </div>
  </div>
}

@if (errorMsgSig) {
  <div class="fixed right-4 top-4 z-50 w-[calc(100%-2rem)] max-w-md pointer-events-none">
    <div
      class="pointer-events-auto rounded-lg border border-red-200 bg-red-50 p-4 text-red-700 shadow-lg animate-in fade-in slide-in-from-top-2 duration-300"
      role="alert"
    >
      <div class="flex items-start gap-3">
        <fa-icon [icon]="faExclamationCircle" class="mt-0.5 flex-shrink-0"></fa-icon>
        <div>
          <p class="font-semibold">Error</p>
          <p class="text-sm break-words">{{ errorMsgSig }}</p>
        </div>
      </div>
    </div>
  </div>
}

@if(examSig) {
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

      <!-- Page Header -->
      <div class="mb-8">
        <div class="flex items-center space-x-4 mb-4">
          <!-- Back Button -->
          <a routerLink="/teacher/exams" class="text-gray-600 hover:text-gray-900 transition">
            <fa-icon [icon]="faArrowLeft" class="text-xl"></fa-icon>
          </a>

          <!-- Main Content -->
          <div class="flex-1">
            <!-- Title and Status Badge -->
            <div class="flex items-center space-x-3 mb-3">
              <h1 class="text-3xl font-bold text-gray-900">{{ examSig.title }}</h1>

            <!-- Status Badge with Icon -->
              @if(examSig.status === 'draft') {
                <span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm font-semibold rounded-full inline-flex items-center gap-1">
                  <fa-icon [icon]="faPencilAlt" class="text-xs"></fa-icon>
                  <span>Draft</span>
                </span>
              } @else if(examSig.status === 'active') {
                <span class="px-3 py-1 bg-blue-100 text-blue-700 text-sm font-semibold rounded-full inline-flex items-center gap-1">
                  <fa-icon [icon]="faClipboardCheck" class="text-xs"></fa-icon>
                  <span>Active</span>
                </span>
              } @else if(examSig.status === 'published') {
                <span class="px-3 py-1 bg-green-100 text-green-700 text-sm font-semibold rounded-full inline-flex items-center gap-1">
                  <fa-icon [icon]="faCheckCircle" class="text-xs"></fa-icon>
                  <span>Published</span>
                </span>
              } @else if(examSig.status === 'archived') {
                <span class="px-3 py-1 bg-red-100 text-red-700 text-sm font-semibold rounded-full inline-flex items-center gap-1">
                  <fa-icon [icon]="faArchive" class="text-xs"></fa-icon>
                  <span>Archived</span>
                </span>
              }
            </div>

            <!-- Description -->
            <p class="text-gray-600 mt-2">{{ examSig.description }}</p>

            <!-- Date and Time Summary -->
            <div class="flex flex-wrap items-center gap-4 mt-3 text-sm text-gray-700">
              @if(examSig.starts_at) {
                <div class="flex items-center gap-2">
                  <fa-icon [icon]="faCalendar" class="text-indigo-600"></fa-icon>
                  <span class="font-medium">{{ examSig.starts_at | date: 'MMM dd, yyyy' }}</span>
                </div>
              }
              @if(examSig.starts_at) {
                <div class="flex items-center gap-2">
                  <fa-icon [icon]="faClock" class="text-blue-600"></fa-icon>
                  <span class="font-medium">{{ examSig.starts_at | date: 'h:mm a' }} - {{ examSig.ends_at | date: 'h:mm a' }}</span>
                </div>
              }
            </div>

            <!-- Year and Sections Summary -->
            <div class="flex flex-wrap items-center gap-3 mt-3">
              @if(examSig.year && examSig.year.length > 0) {
                <div class="flex items-center gap-2">
                  <span class="text-xs font-medium text-gray-500 uppercase">
                    <fa-icon [icon]="faGraduationCap" class="mr-1"></fa-icon>Year:
                  </span>
                  @for(y of examSig.year; track $index) {
                    <span class="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded">
                      {{ y }}
                    </span>
                  }
                </div>
              }

              @if(examSig.sections && examSig.sections.length > 0) {
                <div class="flex items-center gap-2">
                  <span class="text-xs font-medium text-gray-500 uppercase">
                    <fa-icon [icon]="faChalkboardUser" class="mr-1"></fa-icon>Section:
                  </span>
                  @for(section of examSig.sections; track $index) {
                    <span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded uppercase">
                      {{ section }}
                    </span>
                  }
                </div>
              }
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex space-x-2">
            <button
              type="button"
              (click)="openStatusModal()"
              class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition duration-200 inline-flex items-center gap-2">
              <fa-icon [icon]="faSync"></fa-icon>
              <span>Update Status</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Stats Overview -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Questions -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">Total Questions</p>
              <p class="text-3xl font-bold text-gray-900 mt-2">{{ exam()?.items?.length ?? 0 }}</p>
            </div>
            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
              <fa-icon [icon]="faQuestionCircle" class="text-xl text-blue-600"></fa-icon>
            </div>
          </div>
        </div>

        <!-- Total Points -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500 hover:shadow-lg transition">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">Total Points</p>
              <p class="text-3xl font-bold text-gray-900 mt-2">{{ exam()?.total_points }}</p>
            </div>
            <div class="bg-yellow-100 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
              <fa-icon [icon]="faStar" class="text-xl text-yellow-600"></fa-icon>
            </div>
          </div>
        </div>

        <!-- Total Takers -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">Total Takers</p>
              <p class="text-3xl font-bold text-gray-900 mt-2">{{ totalTakers() }}</p>
            </div>
            <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
              <fa-icon [icon]="faUsers" class="text-xl text-green-600"></fa-icon>
            </div>
          </div>
        </div>

        <!-- Completed -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-lg transition">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">Completed</p>
              <p class="text-3xl font-bold text-gray-900 mt-2">{{ completedCount() }}</p>
            </div>
            <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
              <fa-icon [icon]="faCheckCircle" class="text-xl text-purple-600"></fa-icon>
            </div>
          </div>
        </div>

        <!-- Average Score -->
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-indigo-500 hover:shadow-lg transition">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm font-medium">Average Score</p>
              <p class="text-3xl font-bold text-gray-900 mt-2">{{ averageScore() > 0 ? averageScore() : '--' }}</p>
            </div>
            <div class="bg-indigo-100 w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0">
              <fa-icon [icon]="faChartLine" class="text-xl text-indigo-600"></fa-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Content Sections -->
      @if (showTabsSig) {
        <!-- Tab Navigation -->
        <div class="bg-white rounded-t-lg shadow-sm border border-gray-200 overflow-hidden">
          <div class="border-b border-gray-200">
            <nav class="flex">
              <a
                [routerLink]="['overview']"
                routerLinkActive="border-indigo-500 text-indigo-600"
                [routerLinkActiveOptions]="{ exact: true }"
                class="flex-1 px-6 py-4 text-sm font-medium transition border-b-2 border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer text-center">
                Overview
              </a>
              <a
                [routerLink]="['items']"
                routerLinkActive="border-indigo-500 text-indigo-600"
                [routerLinkActiveOptions]="{ exact: true }"
                class="flex-1 px-6 py-4 text-sm font-medium transition border-b-2 border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer text-center">
                Questions
              </a>
              <a
                [routerLink]="['takers']"
                routerLinkActive="border-indigo-500 text-indigo-600"
                [routerLinkActiveOptions]="{ exact: true }"
                class="flex-1 px-6 py-4 text-sm font-medium transition border-b-2 border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer text-center">
                Takers
              </a>
              <a
                [routerLink]="['analytics']"
                routerLinkActive="border-indigo-500 text-indigo-600"
                [routerLinkActiveOptions]="{ exact: true }"
                class="flex-1 px-6 py-4 text-sm font-medium transition border-b-2 border-gray-200 text-gray-500 hover:text-gray-700 hover:border-gray-300 cursor-pointer text-center">
                Analytics
              </a>
            </nav>
          </div>

          <!-- Tab Content -->
          <div class="p-6">
            <div class="space-y-4">
              <router-outlet></router-outlet>
            </div>
          </div>
        </div>
      } @else {
        <!-- No tabs for draft exams - show TOS directly -->
        @if (examSig?.tos?.length) {
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 space-y-4">
            <div class="flex items-center gap-2 mb-6">
              <h2 class="text-xl font-bold text-gray-900">Table of Specifications</h2>
              <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">
                {{ examSig.tos.length }} Topics
              </span>
            </div>

            @for (t of examSig.tos; track $index) {
              <div class="rounded-lg border border-gray-200 bg-gray-50 p-6 space-y-4">
                <!-- Topic Header -->
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{{ t.topic }}</h3>
                </div>

                <!-- Outcomes -->
                @if (t.outcomes && t.outcomes.length) {
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-2">Learning Outcomes</p>
                    <ul class="list-disc pl-5 space-y-1">
                      @for (o of t.outcomes; track $index) {
                        <li class="text-sm text-gray-700">{{ o }}</li>
                      }
                    </ul>
                  </div>
                }

                <!-- Time and Items Info -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 bg-white rounded p-4">
                  <div>
                    <p class="text-xs text-gray-600 font-semibold">Time Allotment</p>
                    <p class="text-sm font-medium text-gray-900">{{ t.time_allotment }} minutes</p>
                  </div>
                  <div>
                    <p class="text-xs text-gray-600 font-semibold">No. of Items</p>
                    <p class="text-sm font-medium text-gray-900">{{ t.no_of_items }} items</p>
                  </div>
                </div>

                <!-- Distribution by Difficulty -->
                @if (t.distribution) {
                  <div>
                    <p class="text-xs font-semibold text-gray-700 mb-3">Distribution by Difficulty</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <!-- Easy -->
                      <div class="rounded-lg border border-gray-300 p-4 bg-white hover:border-green-300 hover:bg-green-50 transition">
                        <p class="text-sm font-semibold text-gray-900 mb-2">Easy</p>
                        <p class="text-xs text-gray-600">Allocation: <span class="font-bold text-gray-900">{{ t.distribution.easy.allocation || 0 }}</span></p>
                      </div>

                      <!-- Moderate -->
                      <div class="rounded-lg border border-gray-300 p-4 bg-white hover:border-yellow-300 hover:bg-yellow-50 transition">
                        <p class="text-sm font-semibold text-gray-900 mb-2">Moderate</p>
                        <p class="text-xs text-gray-600">Allocation: <span class="font-bold text-gray-900">{{ t.distribution.moderate.allocation || 0 }}</span></p>
                      </div>

                      <!-- Difficult -->
                      <div class="rounded-lg border border-gray-300 p-4 bg-white hover:border-red-300 hover:bg-red-50 transition">
                        <p class="text-sm font-semibold text-gray-900 mb-2">Difficult</p>
                        <p class="text-xs text-gray-600">Allocation: <span class="font-bold text-gray-900">{{ t.distribution.difficult.allocation || 0 }}</span></p>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }
      }

    @if(examSig.status === 'draft') {
      <button
        type="button"
        (click)="confirmDelete(examSig.id)"
        class="mt-5 w-full px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition duration-200 flex items-center justify-center gap-2">
        <fa-icon [icon]="faTrash"></fa-icon>
        <span>Delete</span>
      </button>
    }
    </div>
  </div>
}
