<!-- signals on top  -->

@if (!loading()) {
<div class="space-y-6 container mx-auto mt-10">
  @if(!exam()){
  <div class="p-10 border border-dashed rounded-lg text-center bg-white">
    <p class="text-gray-600 font-medium mb-2">Exam not found</p>
    <a routerLink="/teacher/exams" class="text-sm text-blue-600 hover:underline"
      >Return to exams list</a
    >
  </div>
  } @if(exam()){
  <div
    class="flex flex-col md:flex-row md:items-start md:justify-between gap-4"
  >
    <div>
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-2xl font-bold text-gray-900">{{ exam()?.title }}</h1>
        <span
          class="px-2 py-0.5 text-xs font-semibold rounded-full tracking-wide uppercase {{ statusBadge(exam()?.status) }}"
          >{{ exam()?.status }}</span
        >
      </div>
      @if(exam()?.description) {
      <p class="text-sm text-gray-600 max-w-prose">{{ exam()?.description }}</p>
      }
      <div class="mt-3 flex flex-wrap gap-4 text-xs text-gray-500">
        @if(exam()?.starts_at){<span
          >Starts: {{ exam()?.starts_at | date:'medium' }}</span
        >} @if(exam()?.ends_at){<span
          >Ends: {{ exam()?.ends_at | date:'medium' }}</span
        >}
        <span>Created: {{ exam()?.created_at | date:'short' }}</span>
        <span>Updated: {{ exam()?.updated_at | date:'short' }}</span>
        <span
          >Year {{ exam()?.year }} • Section {{ exam()?.section | uppercase
          }}</span
        >
      </div>
    </div>
    <div class="flex items-center gap-2 self-start">
      <a
        routerLink="/teacher/exams"
        class="px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200 text-sm font-medium"
        >Back</a
      >

      @if(exam(); as exam) { @if (exam.status == "active") {
      <a
        [routerLink]="['/teacher/exams/view-exam', exam!.id, 'takers']"
        class="px-3 py-2 rounded-md bg-purple-100 hover:bg-purple-200 text-sm font-medium"
        >Exam Takers</a
      >
      } } @if(isEditable()) {
      <span class="text-xs px-2 py-1 bg-gray-100 rounded font-medium"
        >Draft (editable)</span
      >
      } @else {
      <span class="text-xs px-2 py-1 bg-gray-100 rounded font-medium"
        >Read Only</span
      >
      } @if(allowedNextStatuses().length){
      <select
        (change)="updateStatus($any($event.target).value)"
        class="text-sm border rounded px-2 py-2 bg-white"
      >
        <option value="">Change Status...</option>
        @for(opt of allowedNextStatuses(); track opt.value){
        <option [value]="opt.value">→ {{ opt.label }}</option>
        }
      </select>
      }
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <app-view-exam-count-card
      [totalPointsSig]="totalPoints()"
      [titleSig]="'Total Points'"
      [colorSig]="'text-blue-700'"
    ></app-view-exam-count-card>
    <app-view-exam-count-card
      [totalPointsSig]="mcqCount()"
      [titleSig]="'MCQ'"
      [colorSig]="'text-blue-600'"
    ></app-view-exam-count-card>

    <app-view-exam-count-card
      [totalPointsSig]="tfCount()"
      [titleSig]="'True/False'"
      [colorSig]="'text-indigo-600'"
    ></app-view-exam-count-card>
    <app-view-exam-count-card
      [totalPointsSig]="essayCount()"
      [titleSig]="'Essay'"
      [colorSig]="'text-emerald-600'"
    ></app-view-exam-count-card>
  </div>

  <!-- Item authoring & list -->
  <div class="space-y-8">
    <div
      class="grid md:grid-cols-3 gap-6"
      [class.opacity-50]="!isEditable()"
      [class.pointer-events-none]="!isEditable()"
    >
      <!-- MCQ (Reusable Form Component now creates items) -->
      <div class="bg-white border rounded-lg p-4 shadow-sm">
        <h3 class="text-sm font-semibold mb-3">Add MCQ</h3>
        <app-mcq-form [examIdSig]="exam()?.id!"></app-mcq-form>
      </div>
      <!-- True/False (Reusable Form Component) -->
      <div class="bg-white border rounded-lg p-4 shadow-sm">
        <h3 class="text-sm font-semibold mb-3">Add True / False</h3>
        <app-true-or-false-form
          [examIdSig]="exam()?.id!"
        ></app-true-or-false-form>
      </div>
      <!-- Essay -->
      <div class="bg-white border rounded-lg p-4 shadow-sm">
        <h3 class="text-sm font-semibold mb-3">Add Essay</h3>
        <app-essay-form
          [examIdSig]="exam()?.id!"
          (itemCreated)="onEssayItemCreated($event)"
        ></app-essay-form>
      </div>
    </div>

    <app-teacher-view-exam-items-list></app-teacher-view-exam-items-list>
  </div>
  }
</div>
} @else {
<div class="p-10 text-center text-gray-500">Loading exam...</div>
}
